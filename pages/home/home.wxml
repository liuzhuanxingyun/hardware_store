<!--pages/home/home.wxml-->
<view class="container-main">
  <!-- 1. 自定义导航栏 -->
  <navigation-bar title="五金卫浴商城" back="{{false}}" background="#f7f9fb"></navigation-bar>

  <view class="scroll-content">
    <!-- 2. 搜索框区域 -->
    <view class="search-wrapper">
      <view class="search-bar">
        <icon type="search" size="16" color="#999"></icon>
        <text class="search-placeholder">搜索水龙头、花洒、螺丝...</text>
      </view>
    </view>

    <!-- 3. 轮播图 -->
    <swiper class="banner-swiper" indicator-dots indicator-active-color="#fff" autoplay interval="4000" circular>
      <!-- 注意：这里 wx:key 最好改成 id，因为后端返回的数据里有 id -->
      <block wx:for="{{banners}}" wx:key="id">
        <swiper-item>
          <!-- 核心修改：src="{{item}}" 改为 src="{{item.img}}" -->
          <image class="banner-img" src="{{item.img}}" mode="aspectFill"></image>
        </swiper-item>
      </block>
    </swiper>

    <!-- 4. 金刚区（快捷分类） -->
    <view class="category-grid">
      <block wx:for="{{categories}}" wx:key="id">
        <view class="category-item" bindtap="onCategoryTap" data-id="{{item.id}}">
          <image class="category-icon" src="{{item.icon}}" mode="aspectFit"></image>
          <text class="category-name">{{item.name}}</text>
        </view>
      </block>
    </view>

    <!-- 5. 推荐商品 -->
    <view class="section-header">
      <text class="section-title">热销推荐</text>
      <text class="section-more">查看全部 ></text>
    </view>
    
    <view class="goods-list">
      <block wx:for="{{goodsList}}" wx:key="id">
        <view class="goods-item" bindtap="onGoodsTap" data-id="{{item.id}}">
          <view class="goods-img-box">
            <image class="goods-img" src="{{item.img}}" mode="aspectFill"></image>
          </view>
          <view class="goods-info">
            <view class="goods-name">{{item.name}}</view>
            <view class="goods-tags" wx:if="{{item.tag}}">
              <text class="tag">{{item.tag}}</text>
            </view>
            <view class="goods-bottom">
              <view class="goods-price">
                <text class="symbol">￥</text>{{item.price}}
              </view>
              <!-- 修改处：添加 catchtap 事件 -->
              <view class="add-btn" catchtap="onAddToCart" data-item="{{item}}">+</view>
            </view>
          </view>
        </view>
      </block>
    </view>
    
    <!-- 底部留白，防止被TabBar遮挡，增加高度 -->
    <view style="height: 120rpx;"></view>
  </view>

  <!-- --- 新增：规格选择弹出层 --- -->
  <view class="mask" wx:if="{{showSpecPopup}}" bindtap="closePopup"></view>
  <view class="spec-popup {{showSpecPopup ? 'show' : ''}}">
    <view class="popup-header">
      <image src="{{currentGoods.img}}" mode="aspectFill" class="popup-img"></image>
      <view class="popup-info">
        <view class="popup-price">￥{{currentPrice || currentGoods.price}}</view>
        <view class="popup-selected">已选：{{currentSpec ? currentSpec.name : '标准规格'}}</view>
      </view>
      <view class="close-btn" bindtap="closePopup">×</view>
    </view>

    <scroll-view scroll-y class="popup-content">
      <view class="spec-section">
        <view class="section-title">规格</view>
        <view class="spec-list">
          <block wx:for="{{currentGoods.specs}}" wx:key="id">
            <view 
              class="spec-item {{currentSpec.id === item.id ? 'active' : ''}}" 
              bindtap="selectSpec" 
              data-spec="{{item}}">
              {{item.name}}
            </view>
          </block>
          <!-- 如果没有规格，显示默认 -->
          <view wx:if="{{!currentGoods.specs || currentGoods.specs.length === 0}}" class="spec-item active">标准规格</view>
        </view>
      </view>

      <view class="count-section">
        <view class="section-title">数量</view>
        <view class="stepper">
          <view class="step-btn minus {{buyCount <= 1 ? 'disabled' : ''}}" bindtap="changeCount" data-type="minus">-</view>
          <input class="step-input" type="number" value="{{buyCount}}" disabled />
          <view class="step-btn plus" bindtap="changeCount" data-type="plus">+</view>
        </view>
      </view>
    </scroll-view>

    <view class="popup-footer">
      <view class="confirm-btn" bindtap="confirmAction">确定加入</view>
    </view>
  </view>

</view>